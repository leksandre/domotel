# Модуль "Страницы" (`page`)

## Возможности
* Создание страниц и наполнение их компонентами

## Компоненты
* Заглушка
* Главный экран
* О проекте
* Галерея
* УТП
* Инфраструктура
* Расположение
* Хедер страницы
* Футер страницы
* Вывод информации об ошибке
* Блок УТП с иконками

## События
* `PageComponentEvent` - событие при изменении содержимого или настроек компонента страницы
* `PageComponentRouteEvent` - событие при операциях с записью маршрута динамического компонента
* `PageEvent` - событие при изменении страницы

## Слушатели
* `AddPageForNewSite` - добавляет страницы по умолчанию для нового сайта, подписан на событие `Kelnik\Core\Events\SiteEvent`
* `DeletePageComponentRouteByModule` - удаляет роуты модуля после очистики базы данных модуля, подписан на событие `Kelnik\Core\Events\ModuleCleared`
* `DeletePages` - удаляет все страницы удаленного сайта, подписан на событие `Kelnik\Core\Events\SiteEvent`
* `ModifyPageTypeByComponent` - изменяет тип страницы в зависимости от добавленного в нее компонента
* `ResetPageCache` - слушатель события `PageEvent`, сбрасывает кеш страницы и страницы связанной с динамическим компонентом.
* `ResetPageComponentRouteCache` - слушатель события `PageComponenRoutetEvent`, сбрасывает кеш компонента, связанного с роутом (`PageLinkService`)
* `ResetPageComponentCache` - слушатель события `PageComponentEvent`, сбрасывает кеш компонента страницы
* `ResetRouteCache` - слушатель событий: `PageEvent`, `PageComponentCache`, `PageComponentRouteCache`.
 Сбрасывает кеш динамических маршрутов и общего кеша маршрутов, если таковой есть.

## Маршруты
Список маршрутов формируется из следующих пунктов:
* маршруты, прописанные в коде, как правило, это файлы из папки `routes` в рамках модуля
* маршруты страниц. Такие маршруты именуются в списке по правилу `kelnik.page.<ID страницы>`, например, `kelnik.page.1`
* маршруты динамических компонентов страниц. Такие маршруты именуются в списке по правилу `kelnik.pageComponentRoute.<ID маршрута компонента>`,
 например, `kelnik.pageComponentRoute.2`. Но формат имени маршрута строго не ограничен и может отличаться от общепринятого.

Маршруты страницы и динамических компонентов направляются на метод `showByRoute` контроллера `PageController`. 
У таких маршрутов в параметрах по умолчанию указан ID страницы. Т.е. поиск страницы в итоге осуществляется по её ID, а не по `slug`.

Список маршрутов страниц и динамических компонентов на страницах сохраняется в кеш. Далее данные с этого кеша выводятся при подгрузке маршрутов в файле `routes/web.php` 
через вызов метода сервиса `resolve(PageService::class)->loadPageRoutes()`.

Кеш маршрутов сбрасывается в случаях:
* Операции с записью страницы: включение, отключение, изменение `slug`, перенос страницы в рамках дерева сайта
* Операции с динамическими компонентами страницы: включение, отключение, изменение некоторых параметров компонента
* Операции со списком маршрутов динамического компонента

Если применяется [общее кеширования маршрутов на уровне фреймворка](https://laravel.com/docs/8.x/routing#route-caching), 
то после сброса кеша и генерации нового кеша маршрута страниц будет пересобран общий кеш маршрутов фреймворка.
Более подробно процедуру обновления кеша маршрутов можно посмотреть в слушателе - `src/Listeners/ResetRouteCache.php`

## Stack и Push в Blade шаблонах
Т.к. контент страницы формируется путем поочередного вызова компонентов (`Kelnik\Page\Services\PageService::getPageContent`), а не формированием blade шаблона с вставкой в него компонента,
то после каждого вызова компонента производится сбор данных для списка стеков.
Передача данных в стек "из коробки" в данном случае не срабатывает, т.к. после выполнения данные по фабрике `View` очищаются. 
Далее в шаблоне страницы `kelnik-page::page` производится проверка массива для каждого из стеков. 
При необходимости производится вызов `@push` для конкретного стека.

## Компоновщики
* `BodyAttributes` - передает в шаблон `kelnik-page::app` название класса для блока `body`, если включена анимация в настройках сайта.

## SEO
Для установки сео тегов используется пакет [SEOTools](https://github.com/artesaos/seotools). <br>
Заголовок страницы устанавливается в `Kelnik\Page\Http\Controllers\PageController::setMeta`. 
Вывод заголовка и мета тегов производится в шаблоне `kelnik-page::page`.
