# Подмодуль "Импорт квартирографии" (`estate-import`)

## Возможности

* Управление импортом
* Настройка источников импорта

## События

* `HistoryModelEvent` - при операциях с записями истории импорта

## Слушатели

* `HistoryDeleted` - удаляет данные записи истории

## Задачи

* `AddDataFromSource` - добавляет данные из источника в очередь импорта
* `CleanModuleData` - очищает базу данных модуля
* `FinalizeImportQueue` - производит завершающие действия импорта после выполнения всей цепочки данных
* `HistoryQueueProcessing` - производит выборку одной записи из истории со статусом `new` или `ready` 
 и запускает пре-импорт или непосредственный процесс импорта. 
 Результатом выполнения пре-импорта является создание цепочки данных для импорта в БД квартирографии.
* `ImportDataQueueRow` - обрабатывает одну запись данных (модель `DataQueue`) определенной записи истории (модель `History`)
* `RemoveHistoryData` - удаляет все данные с файловой системы, связанные с записью истории. Запускается слушателем `HistoryDeleted`.
* `RemoveOldHistory` - удаляет старые записи из истории импорта (старше 1 месяца) и статусом `done`.

## Раписание задач

* Каждые 2 минуты запуск `HistoryQueueProcessing`
* Каждый день в 04:00 запуск `RemoveOldHistory`
* Каждые 6 часов `AddDataFromSource`

Настроить расписание можно в конфиге модуля.

## Схема импорта

1) Добавляется запись в историю импорта со статусом `new` и указанием класса пре-импорта.
2) Запускается процесс пре-импорта (подготовки данных).<br>Устанавливается статус `pre-process`.<br>
Формируется очередь данных (из объектов посредников) для импорта в БД квартирографии.

3) По окончанию пре-импорта статус записи в истории переводится в состояние `ready`
4) Следующим запускается непосредственно импорт данных. Статус записи устанавливается как `process`
5) По завершению импорта устанавливается статус `done`
6) Также результатом выполнения шагов `pre-process` и `process` может быть ошибка, в таком случае устанавливается статус `error`
7) Если процесс импорта завершился успешно, то далее вызывается задача `StatUpdate` модуля "Квартирография", 
который производит сбор статистики и сбрасывает кеш модуля.

```text
+-----+     +-------------+     +-------+     +---------+     +------+
| new | --> | pre-process | --> | ready | --> | process | --> | done |
+-----+     +-------------+     +-------+     +---------+     +------+
                          \                             \
                           \    +-------+                \    +-------+
                            \-> | error |                 \-> | error |
                                +-------+                     +-------+ 
```

## Источники данных (`SourceType`)

Безовый абстрактный класс для всех источников - `Sources/Contracts/SourceType.php`.

При запуске задачи `AddDataFromSource` проверяется может ли такой источник запускаться по расписанию. 
Далее вызывается метод `runImport`, если такой источник можно запускать по расписанию.

Список источников:

* [Allio](https://allio.ru/)
* Csv файл
* [ProfitBase](https://profitbase.ru/)
* Xml файл

Из данного списка по расписанию не может запускаться только Csv, т.к. файл импортируется из панели администратора.

Каждый иссточник имеет свои настройки, доступные в панели администратора.

## Подготовка данных (`Pre-processor`)

Общая схема подготовки данных следующая

* Перед добавлением задачи в очередь у препроцессора вызывается метод `prepareData`. 
У большинства источников этот метод пустой.
* После запуска задачи вызывается метод `execute`
* В процессе выполнения для каждой из импортируемых сущностей запускается свой маппер. 
После обработки маппером получаем заполненную модель на основе `EstateModelProxy`, 
которая сохраняется в очередь импорта для следующего шага.

```text
+---------------------+     +--------+     +------------------+
| Данные из источника | --> | Mapper | --> | EstateModelProxy |
+---------------------+     +--------+     +------------------+
```

### Контракты

* `PreProcessor/Contracts/PreProcessor` - базовый класс пре процессора
* `PreProcessor/Contracts/Mapper` - базовый класс маппера
* `PreProcessor/Contracts/MapperDto` - базовый класс для DTO маппера

## Импорт данных (`Import processor`)

### Контракты

* `Processor/Contracts/Processor` - базовый контракт для классов импорта данных

### Классы

* `Processor/ImportProcessor` - класс импорта данных в БД квартирографии

## Преобразователи данных

* `ValueExtractors/Contracts/ValueExtractor` - контракт класса преобразователя данных

**Базовые преобразователи**
* `ArrayValueExtractor` - обработчик массивов. Входные параметры: `$value, $callback`
* `DateTimeValueExtractor` - преобразование в объект `DateTimeInterface`. Входные параметры: `$value, $format`
* `FloatValueExtractor` - преобразование к дробному числу
* `IntValueExtractor` - преобразование к целому числу
* `StringValueExtractor` - преобразование к строке

## Операции с сущностями квартирографии
Для внесения изменений в базу квартирографии используются классы посредники. 
Базовый класс посредника - `EstateModelProxy.php`. 

**Общая схема проведения данных в базу квартирографии**

```text
+---------------------+     +------------------+     +-------------+
| Данные из источника | --> | EstateModelProxy | --> | EstateModel |
+---------------------+     +------------------+     +-------------+
```
